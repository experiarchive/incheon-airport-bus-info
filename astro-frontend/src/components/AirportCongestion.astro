---
---

<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 border border-gray-200 dark:border-gray-700" id="airport-congestion-card" style="display: none;">
  <div class="flex items-center mb-4">
    <svg class="w-6 h-6 mr-3 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
    </svg>
    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">
      인천공항 출국장 실시간 혼잡도
    </h2>
  </div>
  
  <p class="text-gray-600 dark:text-gray-300 mb-6 text-sm">
    <span id="update-time" class="font-medium text-gray-500">업데이트 중...</span> 기준 실시간 대기인원입니다.
  </p>

  <!-- Terminal 1 -->
  <div class="mb-6">
    <h3 class="font-bold text-lg text-gray-800 dark:text-gray-200 mb-3 flex items-center">
      <span class="w-2 h-8 bg-blue-600 rounded-sm mr-2"></span>
      제1여객터미널 (T1)
    </h3>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="t1-grid">
      <!-- T1 Gates will be injected here -->
    </div>
  </div>

  <!-- Terminal 2 -->
  <div>
    <h3 class="font-bold text-lg text-gray-800 dark:text-gray-200 mb-3 flex items-center">
      <span class="w-2 h-8 bg-green-600 rounded-sm mr-2"></span>
      제2여객터미널 (T2)
    </h3>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="t2-grid">
      <!-- T2 Gates will be injected here -->
    </div>
  </div>
  
  <p class="mt-6 text-xs text-gray-400 text-right">
    데이터 제공: 인천국제공항공사 (API 상태에 따라 지연될 수 있습니다)
  </p>
</div>

<script>
  // Client-side script to fetch API data
  async function fetchCongestionData() {
    // Fetch from our own Vercel Serverless Function
    // This resolves CORS and API Key encoding issues permanently
    const URL = '/api/congestion';

    try {
      const response = await fetch(URL);
      if (!response.ok) {
        const errorText = await response.text();
        console.error('API Error Response:', errorText);
        throw new Error(`Network response was not ok: ${response.status}`);
      }
      const data = await response.json();
      
      const items = data.response?.body?.items;
      if (items && items.length > 0) {
        renderCongestionData(items);
        document.getElementById('airport-congestion-card').style.display = 'block';
      }
    } catch (error) {
      console.error('Failed to fetch airport congestion data:', error);
      
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        console.warn('Using mock data for development testing.');
        const MOCK_DATA = [
          // T1: Typically Gates 2, 3, 4, 5 are main. Gate 6 is sometimes open. Gate 1 is rare/closed.
          { ternimalId: 'T1', gatenm: '2번 출국장', gateinfo: 120, cgtdt: '202312071300' },
          { ternimalId: 'T1', gatenm: '3번 출국장', gateinfo: 230, cgtdt: '202312071300' },
          { ternimalId: 'T1', gatenm: '4번 출국장', gateinfo: 150, cgtdt: '202312071300' },
          { ternimalId: 'T1', gatenm: '5번 출국장', gateinfo: 80, cgtdt: '202312071300' },
          { ternimalId: 'T1', gatenm: '6번 출국장', gateinfo: 90, cgtdt: '202312071300' },
          
          // T2: Typically Gates 1, 2
          { ternimalId: 'T2', gatenm: '1번 출국장', gateinfo: 300, cgtdt: '202312071300' },
          { ternimalId: 'T2', gatenm: '2번 출국장', gateinfo: 450, cgtdt: '202312071300' }
        ];
        renderCongestionData(MOCK_DATA);
        const card = document.getElementById('airport-congestion-card');
        if (card) card.style.display = 'block';
      } else {
        const card = document.getElementById('airport-congestion-card');
        if (card) card.style.display = 'none';
      }
    }
  }

  function renderCongestionData(data) {
    const t1Container = document.getElementById('t1-grid');
    const t2Container = document.getElementById('t2-grid');
    const timeElement = document.getElementById('update-time');
    
    if (!t1Container || !t2Container) return;

    t1Container.innerHTML = '';
    t2Container.innerHTML = '';

    let lastUpdate = '';

    // Sort items by Gate Name properly
    data.sort((a, b) => {
      if (a.gatenm < b.gatenm) return -1;
      if (a.gatenm > b.gatenm) return 1;
      return 0;
    });

    // Map Gate IDs to friendly names
    // T1: DG1_E/W -> 2번, DG2 -> 3번... 
    // Reference: Incheon Airport usually maps DG codes to physical gate numbers.
    // Based on common API patterns:
    // DG1 -> 2번 출국장
    // DG2 -> 3번 출국장
    // DG3 -> 4번 출국장
    // DG4 -> 5번 출국장
    // DG5 -> 6번 출국장 (Actually T1 has 2-5 common, 6 is special?)
    // Let's deduce or use generic names if unsure.
    // Better strategy: Map known IDs.
    const gateMapping = {
      'DG1_E': '2번 출국장 (동)', 'DG1_W': '2번 출국장 (서)',
      'DG2_E': '3번 출국장 (동)', 'DG2_W': '3번 출국장 (서)',
      'DG3_E': '4번 출국장 (동)', 'DG3_W': '4번 출국장 (서)',
      'DG4_E': '5번 출국장 (동)', 'DG4_W': '5번 출국장 (서)',
      'DG5_E': '6번 출국장 (동)', 'DG5_W': '6번 출국장 (서)', // Assuming structure
      'DG6_E': '기타 출국장', 'DG6_W': '기타 출국장'
    };
    
    // T1 has gates 2, 3, 4, 5, 6.
    // Simplifying display to aggregate or show distinct if data allows.
    // For now, map directly.

    data.forEach(item => {
      // API Field Parsing
      const count = parseInt(item.waitTime || 0); // 'waitTime' is the field for person count in this API
      const rawGateId = item.gateId;
      
      // Determine Name
      let name = gateMapping[rawGateId] || rawGateId;
      
      // Simplify Name: Remove (동)/(서) to group or just keep detailed
      // User asked for "2번 출국장", "3번 출국장"...
      // Let's extract the number. DG1 -> 2, DG2 -> 3.
      if (rawGateId.startsWith('DG')) {
        const num = parseInt(rawGateId.charAt(2));
        if (!isNaN(num)) {
          // Approximate mapping based on experience: DG1=2, DG2=3, DG3=4, DG4=5. 
          // But actually DG1 is Gate 2.
          // Let's use the explicit generic names for safety.
          name = `${num + 1}번 출국장`; 
          
          // E/W distinction might refer to multiple processing lines. 
          // We can show them as "2번 출국장 (A)" or just list them.
          // For clean UI, appending (동/서) is accurate.
          const direction = rawGateId.includes('_E') ? '(동)' : '(서)';
          name = `${num + 1}번 출국장 ${direction}`;
        }
      }

      const cardHtml = createGateCard(name, count);

      if (item.terminalId === 'P01') { // T1
        t1Container.innerHTML += cardHtml;
      } else if (item.terminalId === 'P02') { // T2
        t2Container.innerHTML += cardHtml;
      }

      // Time parsing (occurtime: YYYYMMDDHHMMSS)
      if (item.occurtime && !lastUpdate) {
          const t = item.occurtime;
          lastUpdate = `${t.substring(8, 10)}:${t.substring(10, 12)}`;
      }
    });

    if (timeElement && lastUpdate) {
      timeElement.textContent = `오늘 ${lastUpdate}`;
    }
  }

  function createGateCard(name, count) {
    let status = '원활';
    let colorClass = 'bg-green-50 text-green-700 border-green-200';
    let dotClass = 'bg-green-500';
    
    // Detailed criteria
    // < 200: Good
    // 200-500: Normal
    // 500+: Crowded
    if (count >= 500) {
      status = '매우 혼잡';
      colorClass = 'bg-red-50 text-red-700 border-red-200';
      dotClass = 'bg-red-500';
    } else if (count >= 200) {
      status = '보통';
      colorClass = 'bg-yellow-50 text-yellow-700 border-yellow-200';
      dotClass = 'bg-yellow-500';
    }

    return `
      <div class="p-3 rounded-lg border flex flex-col items-center justify-center text-center ${colorClass}">
        <div class="text-xs font-semibold mb-1 opacity-80">${name}</div>
        <div class="text-xl font-bold mb-1">${count}명</div>
        <div class="flex items-center text-xs font-medium">
          <span class="w-2 h-2 rounded-full ${dotClass} mr-1.5"></span>
          ${status}
        </div>
      </div>
    `;
  }

  // Init
  fetchCongestionData();
</script>
