---
import Layout from '../layouts/Layout.astro';

// Welcome to Astro! Wondering what to do next? Check out the Astro documentation at https://docs.astro.build
// Don't want to use any of this? Delete everything in this file, the `assets`, `components`, and `layouts` directories, and start fresh.
---

<Layout 
	title="가장 빠른 인천공항 버스 찾기"
	description="인천공항으로 가는 가장 빠른 버스 노선을 검색하고 실시간 시간표, 요금, 정류장 정보를 확인하세요."
	keywords="공항버스, 인천공항, 공항버스 검색, 공항버스 시간표, 공항버스 예매"
>


	<div class="flex flex-col items-center justify-center text-center pt-10 md:pt-16 px-4">
		<h1 class="text-4xl md:text-5xl font-extrabold text-gray-800 dark:text-white mb-4">
			공항버스 검색
		</h1>
		<p class="text-lg text-gray-600 dark:text-gray-300 mb-8 max-w-2xl">
			버스 번호, 정류장, 또는 목적지(예: 강남역)를 입력하여 실시간 운행 정보를 확인하세요.
		</p>

		<div id="search-container" class="w-full max-w-2xl">
			<div class="relative">
				<div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
					<svg class="h-6 w-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
					</svg>
				</div>
				<input
					type="text"
					id="search-input"
					placeholder="버스 번호 또는 정류장/지역명 검색"
					class="w-full p-4 pl-12 text-lg border-2 border-gray-200 dark:border-gray-600 rounded-full shadow-lg focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-800 focus:border-blue-500 dark:focus:border-blue-500 dark:bg-gray-700 dark:text-white transition duration-300"
				/>
			</div>
			<div id="search-results" class="w-full mt-2 bg-white dark:bg-gray-800 rounded-lg shadow-xl hidden overflow-hidden border border-gray-200 dark:border-gray-600 text-left">
				<!-- Search results will be populated here -->
			</div>
		</div>

		<div class="mt-8 text-center">
			<span class="text-gray-600 dark:text-gray-400">주요 노선:</span>
			<a href="/routes/6014" class="ml-2 text-blue-600 hover:underline">6014</a>,
			<a href="/routes/6300" class="ml-2 text-blue-600 hover:underline">6300</a>,
			<a href="/routes/6703" class="ml-2 text-blue-600 hover:underline">6703</a>,
			<a href="/routes/6705A" class="ml-2 text-blue-600 hover:underline">6705A</a>
		</div>
	</div>
</Layout>

<script>
	const searchInput = document.getElementById('search-input') as HTMLInputElement | null;
	const searchResultsContainer = document.getElementById('search-results');
	const searchContainer = document.getElementById('search-container');
	let searchData: any[] = [];

	// Fetch search data
	fetch('/search-data.json')
		.then(response => response.json())
		.then(data => {
			searchData = data;
		})
		.catch(error => console.error('Error fetching search data:', error));

	searchInput?.addEventListener('input', (e) => {
		const query = (e.target as HTMLInputElement).value.toLowerCase().trim();
		
		if (query.length === 0) {
			hideResults();
			return;
		}

		const results: any[] = [];
		const MAX_RESULTS = 7;

		// 1. Find routes that match the route number
		for (const route of searchData) {
			if (route.routeNumber && route.routeNumber.toLowerCase().startsWith(query)) {
				results.push({ type: 'route', ...route });
			}
			if (results.length >= MAX_RESULTS) break;
		}

		// 2. Find routes that have matching stop names
		if (results.length < MAX_RESULTS) {
			for (const route of searchData) {
				const matchedStop = route.stops?.find((stop: string) => stop.toLowerCase().includes(query));
				if (matchedStop) {
					// Avoid adding duplicate routes
					if (!results.some(r => r.routeNumber === route.routeNumber)) {
						results.push({ type: 'route', ...route, match: 'stop', matchedStop });
					}
				}
				if (results.length >= MAX_RESULTS) break;
			}
		}

		displayResults(results);
	});
	
	function displayResults(results: any[]) {
		if (!searchResultsContainer) return;
		if (results.length === 0) {
			searchResultsContainer.innerHTML = `<div class="p-4 text-gray-500">검색 결과가 없습니다.</div>`;
			showResults();
			return;
		}

		searchResultsContainer.innerHTML = results.map((result: any) => {
			if (result.type === 'route') {
				let highlightInfo = '';
				if (result.match === 'stop' && result.matchedStop) {
					highlightInfo = `<span class="text-sm text-green-600 dark:text-green-400 truncate">(일치: ${result.matchedStop})</span>`;
				}

				return `
					<a href="/routes/${result.routeNumber}" class="block p-4 hover:bg-blue-50 dark:hover:bg-blue-900 border-b border-gray-200 dark:border-gray-600 last:border-b-0">
						<div class="flex items-center justify-between">
							<div class="flex items-center min-w-0">
								<span class="text-lg font-bold text-blue-600 dark:text-blue-400 mr-2">${result.routeNumber}</span>
								<span class="text-gray-700 dark:text-gray-300 truncate">${result.routeName || ''}</span>
							</div>
							${highlightInfo}
						</div>
					</a>
				`;
			}
			return '';
		}).join('');

		showResults();
	}

	function showResults() {
		searchResultsContainer?.classList.remove('hidden');
	}

	function hideResults() {
		searchResultsContainer?.classList.add('hidden');
	}

	// Hide results when clicking outside
	document.addEventListener('click', (e) => {
		if (searchContainer && !searchContainer.contains(e.target as Node)) {
			hideResults();
		}
	});

</script>
