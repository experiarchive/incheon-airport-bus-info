---
import Layout from '../../layouts/Layout.astro';
import { client } from '../../lib/sanityClient.js';
import { toHTML } from '@portabletext/to-html';

// Define interfaces for better type safety

// Basic Portable Text block type
interface PortableTextBlock {
  _type: string;
  [key: string]: any;
}

interface TimetableEntry {
  _id?: string;
  route?: { _ref: string; _type: 'reference' };
  dayType: 'weekday' | 'weekend_holiday' | 'everyday' | string;
  direction: string;
  departureTimes: string[];
  stopName?: string;
  effectiveDate?: string;
  status?: string;
}

interface BusRoute {
  _id: string;
  routeName: string;
  routeNumber: string;
  description?: string;
  mainStops?: string[];
  usageGuide?: PortableTextBlock[];
  kakaoMapIframeUrl?: string;
  timetableNotes?: PortableTextBlock[];
}

// Types for JSON data structure (inferred from usage)
interface GeoStop {
  name: string;
  lat: number;
  lng: number;
}

interface GeoInfo {
  stops: GeoStop[];
}

interface UsageGuideLink {
  text: string;
  url: string;
  target?: string;
}

interface UsageGuideItem {
  text: string;
  links?: UsageGuideLink[];
}

interface JsonRouteData {
  fare?: number;
  duration?: string;
  interval?: string;
  company?: string;
  companyTel?: string;
  geoInfo?: GeoInfo;
  usageGuide?: UsageGuideItem[];
  airportStopInfo?: {
    terminal1?: { location?: string };
    terminal2?: { location?: string };
  };
  operationHours?: {
    first: string;
    last: string;
  };
}

// Type for groupedTimetables
interface GroupedTimetables {
  [key: string]: TimetableEntry[];
}

// Type for entriesByStop in timetable rendering
interface StopGroupData {
  stopName?: string;
  dayTypes: {
    [dayType: string]: TimetableEntry[];
  };
}

interface EntriesByStop {
  [stopKey: string]: StopGroupData;
}

// Get the route number from the URL parameter
const { routeNumber } = Astro.params;

// Fetch the specific bus route data from Sanity
const route: BusRoute | null = await client.fetch(`
  *[_type == "busRoute" && routeNumber == $routeNumber][0]{
    routeName,
    routeNumber, 
    description,
    mainStops,
    usageGuide,
    kakaoMapIframeUrl,
    timetableNotes,
    _id
  }
`, { routeNumber });

// If route doesn't exist, return 404
if (!route) {
  return Astro.redirect('/404');
}

// Fetch JSON data for detailed route information
let jsonData: JsonRouteData | null = null;
try {
  // 빌드 시에는 fs 모듈을 사용하여 파일을 직접 읽음
  if (typeof process !== 'undefined' && process.cwd) {
    // 서버 사이드 (빌드 시)
    const fs = await import('fs');
    const path = await import('path');
    const jsonFilePath = path.join(process.cwd(), 'public', 'data', `${routeNumber}.json`);
    
    if (fs.existsSync(jsonFilePath)) {
      const jsonContent = fs.readFileSync(jsonFilePath, 'utf-8');
      jsonData = JSON.parse(jsonContent);
    } else {
      console.log('JSON data file not found:', jsonFilePath);
    }
  } else {
    // 클라이언트 사이드 (런타임)
    const jsonPath = `/data/${routeNumber}.json`;
    const response = await fetch(jsonPath);
    if (response.ok) {
      jsonData = await response.json();
    } else {
      console.log('JSON data not found for route:', routeNumber, 'Status:', response.status);
    }
  }
} catch (error) {
  console.error('Error loading JSON data for route:', routeNumber, error);
}

// Fetch related timetable entries
const timetableEntries: TimetableEntry[] = await client.fetch(`
  *[_type == "timetableEntry" && route._ref == $routeId]{
    dayType,
    direction,
    departureTimes,
    stopName,
    effectiveDate,
    status
  } | order(direction asc, dayType asc, stopName asc)
`, { routeId: route._id });

// Helper function to render portable text
const renderPortableText = (content: PortableTextBlock[] | undefined) => {
  if (!content) return '';
  return toHTML(content);
};

// Group timetable entries by direction and day type
const groupedTimetables: GroupedTimetables = {};
timetableEntries.forEach((entry: TimetableEntry) => {
  const key = `${entry.direction}-${entry.dayType}`;
  if (!groupedTimetables[key]) {
    groupedTimetables[key] = [];
  }
  groupedTimetables[key].push(entry);
});

// Helper function to get day type display name
const getDayTypeDisplay = (dayType: string) => {
  const dayTypeMap: { [key: string]: string } = {
    'weekday': '평일',
    'weekend_holiday': '주말/공휴일',
    'everyday': '매일'
  };
  return dayTypeMap[dayType] || dayType;
};

// Determine mainArea - prioritize first stop
let mainArea: string;

if (jsonData?.geoInfo?.stops && jsonData.geoInfo.stops.length > 0) {
  mainArea = jsonData.geoInfo.stops[0].name;
} else if (route.mainStops && route.mainStops.length > 0) {
  mainArea = route.mainStops[0];
} else {
  // This case should ideally not be reached if stops are always present.
  // Assign a sensible default or handle as an error if appropriate.
  mainArea = '정보 없음'; // Or route.routeName or a generic placeholder
  console.warn(`mainArea could not be determined for route ${route.routeNumber}. Defaulting to '정보 없음'.`);
}

// Generate static paths for all routes
export async function getStaticPaths() {
  const routes: Array<{ routeNumber: string }> = await client.fetch(`
    *[_type == "busRoute"]{
      routeNumber
    }
  `);
  
  return routes.map((route: { routeNumber: string }) => ({
    params: { routeNumber: route.routeNumber },
  }));
}

// Helper function to group departure times by hour for the new layout
const groupTimesByHour = (times: string[]): { [hour: string]: string[] } => {
  const grouped: { [hour: string]: string[] } = {};
  if (!times || times.length === 0) {
    return grouped;
  }
  times.forEach(time => {
    const [hour] = time.split(':');
    if (!grouped[hour]) {
      grouped[hour] = [];
    }
    grouped[hour].push(time); // Store full time string
  });
  return grouped;
};

// SEO-optimized title and description
const seoTitle = `${route.routeNumber} 공항버스 시간표 예매 - ${mainArea}↔인천공항 요금/소요시간`;
const seoDescription = `${route.routeNumber} 공항버스 실시간 시간표와 온라인 예매 서비스. ${mainArea}에서 인천공항까지의 요금, 소요시간, 정류장 위치 정보를 확인하고 편리하게 예매하세요.`;
---

<Layout title={seoTitle}>
  <!-- SEO Meta Tags -->
  <meta name="description" content={seoDescription} />
  <meta name="keywords" content={`${route.routeNumber} 공항버스, ${route.routeNumber} 공항버스 시간표, ${route.routeNumber} 공항버스 예매, ${route.routeNumber} 공항버스 요금, ${mainArea} 공항버스, 공항버스 정류장, 공항버스 소요시간`} />
  
  <!-- Kakao Map API -->
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9dee7ba39e07c39710261487dceadbcb&libraries=services,clusterer,drawing,roadview"></script>
  
  <!-- Structured Data for Transportation Service -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "TransportationService",
    "name": `${route.routeNumber} 공항버스`,
    "description": `${mainArea}에서 인천공항을 연결하는 ${route.routeNumber}번 공항버스 서비스`,
    "provider": {
      "@type": "Organization",
      "name": "인천공항 버스 정보"
    },
    "areaServed": {
      "@type": "Place",
      "name": `${mainArea}, 서울특별시`
    },
    "hasRoute": {
      "@type": "TransportationRoute",
      "name": `${route.routeNumber} 공항버스 노선`,
      "description": `${mainArea}에서 인천공항까지의 직행 노선`
    }
  })}></script>

  <!-- Breadcrumb Schema -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "공항버스",
        "item": `${Astro.url.origin}/`
      },
      {
        "@type": "ListItem", 
        "position": 2,
        "name": "전체 노선",
        "item": `${Astro.url.origin}/routes`
      },
      {
        "@type": "ListItem",
        "position": 3,
        "name": `${route.routeNumber} 공항버스`,
        "item": Astro.url.href // 현재 페이지 URL 추가
      }
    ]
  })}></script>

  <div class="max-w-6xl mx-auto">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb" class="mb-6">
      <div class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
        <a href="/" class="hover:text-blue-600 dark:hover:text-blue-400">공항버스 홈</a>
        <span>></span>
        <a href="/routes" class="hover:text-blue-600 dark:hover:text-blue-400">전체 노선</a>
        <span>></span>
        <span class="text-gray-800 dark:text-gray-200">{route.routeNumber} 공항버스</span>
      </div>
    </nav>

    <!-- Back Button -->
    <div class="mb-6">
      <a 
        href="/routes" 
        class="inline-flex items-center space-x-2 text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium transition duration-200"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        <span>전체 공항버스 노선으로 돌아가기</span>
      </a>
    </div>

    <!-- SEO-Optimized Route Header -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-8 mb-8 border border-gray-200 dark:border-gray-700">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
        <div>
          <div class="flex items-center space-x-4 mb-4">
            <span class="text-4xl font-bold text-blue-600 dark:text-blue-400">
              {route.routeNumber}
            </span>
            <span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-sm font-semibold px-3 py-1 rounded">
              공항버스
            </span>
          </div>
          <!-- SEO H1 with target keywords -->
          <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">
            {mainArea} ↔ 인천공항
          </h1>
        </div>
      </div>
      
      {route.description && (
        <p class="text-lg text-gray-600 dark:text-gray-300 leading-relaxed mb-6">
          {route.description}
        </p>
      )}

      <!-- Enhanced Route Information from JSON -->
      {jsonData && (
        <div class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-6">
          <ul class="space-y-6 md:space-y-0 md:grid md:grid-cols-2 md:gap-x-8 md:gap-y-6">
            <li class="flex items-start">
              <div class="flex-shrink-0 w-6 h-6 mr-3 text-blue-600 dark:text-blue-400">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-full h-full">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 21.75z" />
                </svg>
              </div>
              <div>
                <span class="block text-sm font-medium text-gray-600 dark:text-gray-400">요금 정보</span>
                <span class="block text-xl font-bold text-gray-800 dark:text-gray-200">{jsonData.fare?.toLocaleString()}원</span>
              </div>
            </li>

            <li class="flex items-start">
              <div class="flex-shrink-0 w-6 h-6 mr-3 text-green-600 dark:text-green-400">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-full h-full">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <div>
                <span class="block text-sm font-medium text-gray-600 dark:text-gray-400">소요 시간 (평균)</span>
                <span class="block text-lg font-semibold text-gray-800 dark:text-gray-200">{jsonData.duration}</span>
              </div>
            </li>

            <li class="flex items-start">
              <div class="flex-shrink-0 w-6 h-6 mr-3 text-orange-600 dark:text-orange-400">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-full h-full">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.992v4.992m-4.993 0h-4.992" />
                </svg>
              </div>
              <div>
                <span class="block text-sm font-medium text-gray-600 dark:text-gray-400">운행 간격</span>
                <span class="block text-lg font-semibold text-gray-800 dark:text-gray-200">{jsonData.interval}</span>
              </div>
            </li>

            <li class="flex items-start">
              <div class="flex-shrink-0 w-6 h-6 mr-3 text-purple-600 dark:text-purple-400">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-full h-full">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h6.75m-6.75 3.75h6.75m-6.75 3.75h6.75m-6.75 3.75h6.75M6 21v-3.09c0-.621.254-1.194.68-1.615L10.5 12M18 21v-3.09c0-.621-.254-1.194-.68-1.615L13.5 12m0 0V6.75" />
                </svg>
              </div>
              <div>
                <span class="block text-sm font-medium text-gray-600 dark:text-gray-400">운영사</span>
                <span class="block text-lg font-semibold text-gray-800 dark:text-gray-200">{jsonData.company}</span>
                {jsonData.companyTel && (
                  <span class="block text-sm text-gray-500 dark:text-gray-400 mt-0.5">{jsonData.companyTel}</span>
                )}
              </div>
            </li>

            {jsonData.operationHours && (
              <li class="flex items-start">
                <div class="flex-shrink-0 w-6 h-6 mr-3 text-cyan-600 dark:text-cyan-400">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-full h-full">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /> 
                  </svg>
                </div>
                <div>
                  <span class="block text-sm font-medium text-gray-600 dark:text-gray-400">운행 시간</span>
                  <span class="block text-lg font-semibold text-gray-800 dark:text-gray-200">
                    첫차: {jsonData.operationHours.first}
                  </span>
                  <span class="block text-lg font-semibold text-gray-800 dark:text-gray-200 mt-1">
                    막차: {jsonData.operationHours.last}
                  </span>
                </div>
              </li>
            )}
          </ul>
        </div>
      )}
    </div>

    <!-- AdSense: 기본운행정보 섹션 밑 -->
    <div class="mb-8">
      <div class="hidden md:block">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8355312170222120" crossorigin="anonymous"></script>
        <!-- 기본운행정보(AIR) -->
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-8355312170222120"
             data-ad-slot="4961257991"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
          (window.adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      </div>
      <div class="block md:hidden">
        <div style="width:100%; height:250px; margin: 0 auto;">
          <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8355312170222120" crossorigin="anonymous"></script>
          <ins class="adsbygoogle"
               style="display:block;width:100%;height:100%;"
               data-ad-client="ca-pub-8355312170222120"
               data-ad-slot="8588677662"></ins>
          <script>
            (window.adsbygoogle = window.adsbygoogle || []).push({});
          </script>
        </div>
      </div>
    </div>

    <!-- Airport Terminal Stops Section -->
    {jsonData?.airportStopInfo && (jsonData.airportStopInfo.terminal1?.location || jsonData.airportStopInfo.terminal2?.location) && (
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 border border-gray-200 dark:border-gray-700">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
          <svg class="w-6 h-6 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path></svg>
          {route.routeNumber} 공항버스 인천공항 터미널 안내
        </h2>
        <div class="space-y-4">
          {jsonData.airportStopInfo.terminal1?.location && (
            <div class="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg border border-slate-200 dark:border-slate-600">
              <div class="flex items-center mb-2">
                <span class="bg-blue-500 text-white text-xs font-semibold px-2.5 py-0.5 rounded-full mr-3">T1</span>
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">제1여객터미널 승차장</h3>
              </div>
              <p class="text-gray-600 dark:text-gray-300 ml-9">{jsonData.airportStopInfo.terminal1.location}</p>
            </div>
          )}
          {jsonData.airportStopInfo.terminal2?.location && (
            <div class="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg border border-slate-200 dark:border-slate-600">
              <div class="flex items-center mb-2">
                <span class="bg-green-500 text-white text-xs font-semibold px-2.5 py-0.5 rounded-full mr-3">T2</span>
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">제2여객터미널 승차장</h3>
              </div>
              <p class="text-gray-600 dark:text-gray-300 ml-9">{jsonData.airportStopInfo.terminal2.location}</p>
            </div>
          )}
          <div class="mt-4 text-center">
            <a 
              href="https://koreabusinfo.com/icn-bus-info/bus-stops/" 
              target="_blank"
              class="inline-flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200"
            >
              <span>공항 승차/하차 위치보기</span>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
              </svg>
            </a>
          </div>
        </div>
      </div>
    )}

    <!-- Bus Stops with Kakao Map -->
    {jsonData?.geoInfo?.stops && jsonData.geoInfo.stops.length > 0 && (
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 border border-gray-200 dark:border-gray-700">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
          <svg class="w-6 h-6 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          {route.routeNumber} 공항버스 정류장 위치
        </h2>
        <p class="text-gray-600 dark:text-gray-300 mb-6">
          {route.routeNumber} 공항버스 정류장 위치를 지도에서 자세히 확인해보세요.
        </p>

        <div class="mb-6">
          <div id="map" class="w-full h-[60vh] md:h-96 rounded-lg border border-gray-200 dark:border-gray-600"></div>
        </div>

        <div id="roadviewContainer" class="mb-6" style="display: none;">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white">로드뷰</h3>
            <button 
              onclick="closeRoadview()" 
              class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 text-sm font-medium"
            >
              로드뷰 닫기
            </button>
          </div>
          <div id="roadview" class="w-full h-96 rounded-lg border border-gray-200 dark:border-gray-600"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-1 max-h-96 overflow-y-auto">
          {jsonData.geoInfo.stops.map((stop: GeoStop, index: number) => (
            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
              <div class="flex items-center space-x-3">
                <span class="flex-shrink-0 w-5 h-5 bg-blue-600 text-white text-xs font-semibold rounded-full flex items-center justify-center">
                  {index + 1}
                </span>
                <span class="text-gray-800 dark:text-gray-200 font-medium text-lg">{stop.name}</span>
              </div>
              <button 
                onclick={`window.moveToMarkerAndScroll(${index})`}
                class="text-sm px-3 py-2 bg-blue-100 hover:bg-blue-200 dark:bg-blue-900/30 dark:hover:bg-blue-900/50 text-blue-600 dark:text-blue-400 rounded-lg transition-colors duration-150 flex items-center justify-center font-medium"
              >
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0zM15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span>지도</span>
              </button>
            </div>
          ))}
        </div>

        <div id="stopsData" data-stops={JSON.stringify(jsonData.geoInfo.stops)} style="display: none;"></div>
      </div>
    )}

    <!-- Main Stops Section (fallback if no JSON data) -->
    {(!jsonData?.geoInfo?.stops || jsonData.geoInfo.stops.length === 0) && route.mainStops && route.mainStops.length > 0 && (
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 border border-gray-200 dark:border-gray-700">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
          <svg class="w-6 h-6 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          정류장 위치 안내
        </h2>
        <p class="text-gray-600 dark:text-gray-300 mb-4">
          {route.routeNumber} 공항버스가 정차하는 주요 정류장 위치입니다. 각 정류장에서의 탑승 시간을 확인하여 여행 계획을 세우세요.
        </p>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          {route.mainStops.map((stop: string, index: number) => (
            <div class="flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
              <span class="flex-shrink-0 w-6 h-6 bg-blue-600 text-white text-xs font-bold rounded-full flex items-center justify-center">
                {index + 1}
              </span>
              <span class="text-gray-800 dark:text-gray-200 font-medium">{stop}</span>
            </div>
          ))}
        </div>
      </div>
    )}

    <!-- AdSense: 정류장 위치 섹션 밑 -->
    <div class="mb-8">
      <div class="hidden md:block">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8355312170222120" crossorigin="anonymous"></script>
        <!-- 정류장시간표(PC) -->
        <ins class="adsbygoogle"
             style="display:inline-block;width:728px;height:90px"
             data-ad-client="ca-pub-8355312170222120"
             data-ad-slot="7856698853"></ins>
        <script>
          (window.adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      </div>
      <div class="block md:hidden">
        <div style="width:100%; height:100px; margin: 0 auto;">
          <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8355312170222120" crossorigin="anonymous"></script>
          <!-- 정류장시간표(모바일) -->
          <ins class="adsbygoogle"
               style="display:block;width:100%;height:100%;"
               data-ad-client="ca-pub-8355312170222120"
               data-ad-slot="3654322866"></ins>
          <script>
            (window.adsbygoogle = window.adsbygoogle || []).push({});
          </script>
        </div>
      </div>
    </div>

    <!-- Timetable Section - Redesigned for Better UX -->
    {Object.keys(groupedTimetables).length > 0 && (
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 border border-gray-200 dark:border-gray-700">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
          <svg class="w-6 h-6 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          {route.routeNumber} 공항버스 시간표
        </h2>
        <p class="text-gray-600 dark:text-gray-300 mb-6">
          원하는 방향과 정류장을 선택하면 실시간으로 다음 출발 시간을 확인할 수 있습니다.
        </p>

        <!-- Direction Tab Navigation -->
        <div class="mb-6" id="timetable-section">
          <div class="flex space-x-2 mb-4" role="tablist" aria-label="버스 방향 선택">
            <button 
              id="tab-airport" 
              class="flex-1 py-3 px-4 text-center font-medium rounded-lg transition-all duration-200 bg-blue-600 text-white"
              role="tab" 
              aria-selected="true" 
              aria-controls="panel-airport"
              onclick="switchDirection('airport')"
            >
              <div class="flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
                <span>공항으로</span>
              </div>
            </button>
            <button 
              id="tab-city" 
              class="flex-1 py-3 px-4 text-center font-medium rounded-lg transition-all duration-200 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600"
              role="tab" 
              aria-selected="false" 
              aria-controls="panel-city"
              onclick="switchDirection('city')"
            >
              <div class="flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
                <span>시내로</span>
              </div>
            </button>
          </div>

          <!-- Stop Selection -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              정류장 선택
            </label>
            <select 
              id="stop-selector" 
              class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              onchange="selectStop(this.value)"
              aria-label="정류장 선택"
            >
              <option value="">정류장을 선택하세요</option>
            </select>
          </div>

          <!-- Current Time Display -->
          <div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-700">
            <div class="flex items-center justify-between">
              <span class="text-sm text-blue-700 dark:text-blue-300">현재 시간</span>
              <span id="current-time" class="font-mono text-lg font-semibold text-blue-800 dark:text-blue-200"></span>
            </div>
          </div>

          <!-- Airport Direction Panel -->
          <div 
            id="panel-airport" 
            role="tabpanel" 
            aria-labelledby="tab-airport" 
            class="timetable-panel"
          >
            <div class="space-y-4" id="airport-timetables">
              <!-- Airport direction timetables will be rendered here -->
            </div>
          </div>

          <!-- City Direction Panel -->
          <div 
            id="panel-city" 
            role="tabpanel" 
            aria-labelledby="tab-city" 
            class="timetable-panel hidden"
          >
            <div class="space-y-4" id="city-timetables">
              <!-- City direction timetables will be rendered here -->
            </div>
          </div>
        </div>

        {route.timetableNotes && (
          <div class="mt-6 p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
            <h4 class="font-medium text-yellow-800 dark:text-yellow-200 mb-2">시간표 참고사항</h4>
            <div class="text-yellow-700 dark:text-yellow-300 prose prose-sm max-w-none" set:html={renderPortableText(route.timetableNotes)}></div>
          </div>
        )}
      </div>
    )}

    <!-- Usage Guide Section - Enhanced with JSON data -->
    {(route.usageGuide || jsonData?.usageGuide) && (
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 border border-gray-200 dark:border-gray-700">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
          <svg class="w-6 h-6 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          이용 안내 및 예매 정보
        </h2>
        
        <!-- JSON Usage Guide (priority) -->
        {jsonData?.usageGuide && (
          <ul class="space-y-2 list-none mb-4">
            {jsonData.usageGuide.map((guide: UsageGuideItem, index: number) => {
              let displayText = guide.text;
              if (guide.links && guide.links.length > 0) {
                guide.links.forEach((link: UsageGuideLink) => {
                  if (guide.text.includes(link.text)) {
                    displayText = displayText.replace(
                      link.text,
                      `<a href="${link.url}" target="${link.target || '_self'}" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 underline font-medium">${link.text}</a>`
                    );
                  }
                });
              }
              const isLastItem = jsonData.usageGuide && index === jsonData.usageGuide.length - 1;
              return (
                <li class={`flex items-start py-2 ${isLastItem ? '' : 'border-b border-gray-200 dark:border-gray-700'}`}>
                  <svg class="w-5 h-5 mr-3 mt-1 text-blue-500 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="5" />
                  </svg>
                  <span class="text-gray-700 dark:text-gray-300" set:html={displayText}></span>
                </li>
              );
            })}
          </ul>
        )}
        
        <!-- Sanity Usage Guide (fallback) -->
        {route.usageGuide && !jsonData?.usageGuide && (
          <div class="prose prose-lg max-w-none dark:prose-invert" set:html={renderPortableText(route.usageGuide)}></div>
        )}
      </div>
    )}

    <!-- AdSense: 실시간버스 위치 섹션 위 -->
    <div class="mb-8">
      <div class="hidden md:block">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8355312170222120" crossorigin="anonymous"></script>
        <!-- 실시간버스(PC) -->
        <ins class="adsbygoogle"
             style="display:inline-block;width:728px;height:90px"
             data-ad-client="ca-pub-8355312170222120"
             data-ad-slot="3189845476"></ins>
        <script>
          (window.adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      </div>
      <div class="block md:hidden">
        <div style="width:100%; height:100px; margin: 0 auto;">
          <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8355312170222120" crossorigin="anonymous"></script>
          <!-- 실시간버스(모바일) -->
          <ins class="adsbygoogle"
               style="display:block;width:100%;height:100%;"
               data-ad-client="ca-pub-8355312170222120"
               data-ad-slot="2109548155"></ins>
          <script>
            (window.adsbygoogle = window.adsbygoogle || []).push({});
          </script>
        </div>
      </div>
    </div>

    <!-- Kakao Map Section (iframe fallback) -->
    {route.kakaoMapIframeUrl && (
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 border border-gray-200 dark:border-gray-700">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
          <svg class="w-6 h-6 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m-6 3l6-3"></path>
          </svg>
          실시간 버스 위치
        </h2>
        <p class="text-gray-600 dark:text-gray-300 mb-4">
          {route.routeNumber} 공항버스의 실시간 운행 위치를 확인할 수 있습니다.
        </p>
        <div class="w-full h-[60vh] md:h-96 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-600">
          <iframe 
            src={route.kakaoMapIframeUrl}
            width="100%" 
            height="100%" 
            frameborder="0" 
            style="border:0;" 
            allowfullscreen=""
            loading="lazy"
            title={`${route.routeNumber} 공항버스 실시간 위치`}
          ></iframe>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-3">
          * {route.routeNumber} 공항버스 실시간 위치 정보는 카카오맵에서 제공됩니다.
        </p>
      </div>
    )}

    <!-- Airport Usage Guide Section -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 border border-gray-200 dark:border-gray-700">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">
        공항 이용 가이드
      </h2>
      <div class="space-y-4">
        <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border-l-4 border-green-500">
          <h3 class="text-lg font-semibold text-green-800 dark:text-green-200 mb-2">
            인천공항 공항버스 무인발권기 이용 방법
          </h3>
          <p class="text-green-700 dark:text-green-300 mb-3">
            무인발권기를 이용한 티켓 구매 및 예매 내역 확인 방법 안내
          </p>
          <a 
            href="https://koreabusinfo.com/icn-bus-info/unmanned-ticket-machine-guide/" 
            target="_blank"
            class="inline-flex items-center space-x-2 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200"
          >
            <span>무인발권기 이용법 보기</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
            </svg>
          </a>
        </div>
      </div>
    </div>

    <!-- AdSense: 공항이용가이드 섹션 밑 -->
    <div class="mb-8">
      <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8355312170222120"
           crossorigin="anonymous"></script>
      <!-- 공항이용가이드 -->
      <ins class="adsbygoogle"
           style="display:block"
           data-ad-client="ca-pub-8355312170222120"
           data-ad-slot="5622010653"
           data-ad-format="auto"
           data-full-width-responsive="true"></ins>
      <script>
           (window.adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
    <!-- Back to Routes Button -->
    <div class="text-center">
      <a 
        href="/routes" 
        class="inline-flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition duration-200"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        <span>전체 공항버스 노선 목록으로 돌아가기</span>
      </a>
    </div>
  </div>
</Layout>

<script is:inline set:html={`window.timetableData = ${JSON.stringify(timetableEntries)};`} />

<script is:inline>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize all components
  initializeMap();
  initializeTimetable();
  updateCurrentTime();
  
  // Update time every minute
  setInterval(updateCurrentTime, 60000);
});

// Timetable functionality
let currentDirection = 'airport';
let currentSelectedStop = '';
let processedTimetableData = null;

function initializeTimetable() {
  if (!window.timetableData) return;
  
  // Process raw timetable data
  processedTimetableData = processTimetableData(window.timetableData);
  
  // Populate stop selector
  populateStopSelector();
  
  // Render initial timetables
  renderTimetables();
}

function processTimetableData(rawData) {
  const processed = {
    airport: {}, // 공항행
    city: {}     // 시내행
  };
  
  rawData.forEach(entry => {
    const direction = entry.direction === '공항행' ? 'airport' : 'city';
    const stopName = entry.stopName || '정류장명 미등록';
    const dayType = entry.dayType || 'everyday';
    
    if (!processed[direction][stopName]) {
      processed[direction][stopName] = {};
    }
    
    if (!processed[direction][stopName][dayType]) {
      processed[direction][stopName][dayType] = [];
    }
    
    if (entry.departureTimes && entry.departureTimes.length > 0) {
      processed[direction][stopName][dayType] = entry.departureTimes.sort();
    }
  });
  
  return processed;
}

function populateStopSelector() {
  const selector = document.getElementById('stop-selector');
  if (!selector || !processedTimetableData) return;
  
  // Clear existing options except the first one
  while (selector.children.length > 1) {
    selector.removeChild(selector.lastChild);
  }
  
  // Get all unique stops
  const allStops = new Set();
  Object.keys(processedTimetableData.airport).forEach(stop => allStops.add(stop));
  Object.keys(processedTimetableData.city).forEach(stop => allStops.add(stop));
  
  // Try to get stop order from JSON data (geoInfo.stops)
  let orderedStops = [];
  const stopsDataElement = document.getElementById('stopsData');
  
  if (stopsDataElement) {
    try {
      const stopsDataText = stopsDataElement.getAttribute('data-stops');
      if (stopsDataText) {
        const jsonStops = JSON.parse(stopsDataText);
        // Use JSON order for stops that exist in timetable data
        jsonStops.forEach(jsonStop => {
          if (allStops.has(jsonStop.name)) {
            orderedStops.push(jsonStop.name);
          }
        });
      }
    } catch (e) {
      console.warn('Could not parse geo stops data for ordering');
    }
  }
  
  // Add any remaining stops that weren't in the JSON (alphabetically)
  const remainingStops = Array.from(allStops)
    .filter(stop => !orderedStops.includes(stop))
    .sort();
  
  orderedStops = orderedStops.concat(remainingStops);
  
  // Add stops to selector in correct order
  orderedStops.forEach(stopName => {
    const option = document.createElement('option');
    option.value = stopName;
    option.textContent = stopName;
    selector.appendChild(option);
  });
  
  // Set initial stop based on direction
  setInitialStop();
}

function setInitialStop() {
  if (!processedTimetableData) return;
  
  let initialStop = '';
  
  if (currentDirection === 'airport') {
    // For airport direction, use first stop from geo data or first available stop
    const stopsDataElement = document.getElementById('stopsData');
    if (stopsDataElement) {
      try {
        const stopsDataText = stopsDataElement.getAttribute('data-stops');
        if (stopsDataText) {
          const jsonStops = JSON.parse(stopsDataText);
          if (jsonStops.length > 0 && processedTimetableData.airport[jsonStops[0].name]) {
            initialStop = jsonStops[0].name;
          }
        }
      } catch (e) {
        console.warn('Could not parse geo stops data for initial stop');
      }
    }
    
    // Fallback to first available airport stop
    if (!initialStop) {
      const airportStops = Object.keys(processedTimetableData.airport);
      if (airportStops.length > 0) {
        initialStop = airportStops[0];
      }
    }
  } else {
    // For city direction, prefer "인천공항 제2터미널" or "인천공항 2터미널"
    const cityStops = Object.keys(processedTimetableData.city);
    const preferredStops = ['인천공항 제2터미널', '인천공항 2터미널', '인천공항제2터미널'];
    
    for (const preferred of preferredStops) {
      if (cityStops.includes(preferred)) {
        initialStop = preferred;
        break;
      }
    }
    
    // Fallback to first available city stop
    if (!initialStop && cityStops.length > 0) {
      initialStop = cityStops[0];
    }
  }
  
  // Update selector and current selection
  if (initialStop) {
    const selector = document.getElementById('stop-selector');
    if (selector) {
      selector.value = initialStop;
    }
    currentSelectedStop = initialStop;
  }
}

function switchDirection(direction) {
  currentDirection = direction;
  
  // Update tab appearance
  const airportTab = document.getElementById('tab-airport');
  const cityTab = document.getElementById('tab-city');
  const airportPanel = document.getElementById('panel-airport');
  const cityPanel = document.getElementById('panel-city');
  
  if (direction === 'airport') {
    airportTab.className = 'flex-1 py-3 px-4 text-center font-medium rounded-lg transition-all duration-200 bg-blue-600 text-white';
    cityTab.className = 'flex-1 py-3 px-4 text-center font-medium rounded-lg transition-all duration-200 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600';
    airportTab.setAttribute('aria-selected', 'true');
    cityTab.setAttribute('aria-selected', 'false');
    airportPanel.classList.remove('hidden');
    cityPanel.classList.add('hidden');
  } else {
    cityTab.className = 'flex-1 py-3 px-4 text-center font-medium rounded-lg transition-all duration-200 bg-green-600 text-white';
    airportTab.className = 'flex-1 py-3 px-4 text-center font-medium rounded-lg transition-all duration-200 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600';
    cityTab.setAttribute('aria-selected', 'true');
    airportTab.setAttribute('aria-selected', 'false');
    cityPanel.classList.remove('hidden');
    airportPanel.classList.add('hidden');
  }
  
  // Set appropriate initial stop for the direction
  setInitialStop();
  
  renderTimetables();
}

function selectStop(stopName) {
  currentSelectedStop = stopName;
  renderTimetables();
}

function renderTimetables() {
  if (!processedTimetableData) return;
  
  const containerId = currentDirection === 'airport' ? 'airport-timetables' : 'city-timetables';
  const container = document.getElementById(containerId);
  if (!container) return;
  
  container.innerHTML = '';
  
  const directionData = processedTimetableData[currentDirection];
  
  // If no stop is selected, don't show all stops (to avoid scroll pressure)
  // Instead, show message to select a stop
  if (!currentSelectedStop) {
    container.innerHTML = `
      <div class="text-center py-8 text-gray-600 dark:text-gray-400">
        <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
        <p class="text-lg font-medium mb-2">정류장을 선택해주세요</p>
        <p class="text-sm">위의 드롭다운에서 정류장을 선택하면 해당 정류장의 시간표를 확인할 수 있습니다.</p>
      </div>
    `;
    return;
  }
  
  const stopsToShow = [currentSelectedStop];
  
  if (!directionData[currentSelectedStop]) {
    container.innerHTML = '<div class="text-center py-8 text-gray-500 dark:text-gray-400">선택한 정류장의 시간표 정보가 없습니다.</div>';
    return;
  }
  
  stopsToShow.forEach(stopName => {
    if (!directionData[stopName]) return;
    
    const stopCard = createStopTimetableCard(stopName, directionData[stopName]);
    container.appendChild(stopCard);
  });
}

function createStopTimetableCard(stopName, stopData) {
  const card = document.createElement('div');
  card.className = 'border border-gray-200 dark:border-gray-600 rounded-lg overflow-hidden';
  
  const directionColor = currentDirection === 'airport' ? 'blue' : 'green';
  const directionText = currentDirection === 'airport' ? '공항으로' : '시내로';
  
  card.innerHTML = `
    <div class="px-4 py-3 bg-${directionColor}-100 dark:bg-${directionColor}-900/30 border-b border-gray-200 dark:border-gray-600">
      <h3 class="text-lg font-semibold text-${directionColor}-800 dark:text-${directionColor}-200">
        ${stopName} <span class="text-sm font-normal">(${directionText})</span>
      </h3>
    </div>
    <div class="p-4">
      ${Object.entries(stopData).map(([dayType, times]) => createDayTypeSection(dayType, times)).join('')}
    </div>
  `;
  
  return card;
}

function createDayTypeSection(dayType, times) {
  const dayTypeDisplay = getDayTypeDisplay(dayType);
  const now = new Date();
  const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
  
  // Find next departure times
  const upcomingTimes = times.filter(time => time > currentTime).slice(0, 3);
  const nextTime = upcomingTimes[0];
  
  return `
    <div class="mb-6 last:mb-0">
      <div class="flex items-center justify-between mb-3">
        <h4 class="font-medium text-gray-800 dark:text-gray-200">${dayTypeDisplay}</h4>
        ${nextTime ? `<span class="text-sm text-green-600 dark:text-green-400 font-medium">다음 출발: ${nextTime}</span>` : `<span class="text-sm text-gray-500 dark:text-gray-400">운행 종료</span>`}
      </div>
      
      ${upcomingTimes.length > 0 ? `
        <div class="mb-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-700">
          <h5 class="text-sm font-medium text-green-800 dark:text-green-200 mb-2">
            ${upcomingTimes.length === 1 ? '다음 출발시간' : `다음 ${upcomingTimes.length}개 출발시간`}
          </h5>
          <div class="flex flex-wrap gap-2">
            ${upcomingTimes.map((time, index) => `
              <button class="px-3 py-1.5 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 transition-colors ${index === 0 ? 'ring-2 ring-green-300' : ''}" 
                      onclick="highlightTime('${time}')" 
                      aria-label="${time} 출발">
                ${time}
              </button>
            `).join('')}
          </div>
        </div>
      ` : `
        <div class="mb-4 p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg border border-orange-200 dark:border-orange-700">
          <h5 class="text-sm font-medium text-orange-800 dark:text-orange-200 mb-1">운행 종료</h5>
          <p class="text-sm text-orange-700 dark:text-orange-300">오늘 운행이 모두 종료되었습니다. 전체 시간표에서 첫차 시간을 확인하세요.</p>
        </div>
      `}
      
      <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-3">
        <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">전체 시간표</h5>
        <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-2">
          ${times.map(time => `
            <button class="p-2 text-sm text-center rounded border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors ${time === nextTime ? 'bg-green-100 dark:bg-green-900/30 border-green-300 dark:border-green-700' : 'bg-white dark:bg-gray-800'}" 
                    onclick="highlightTime('${time}')" 
                    aria-label="${time} 출발">
              ${time}
            </button>
          `).join('')}
        </div>
      </div>
    </div>
  `;
}

function getDayTypeDisplay(dayType) {
  const dayTypeMap = {
    'weekday': '평일',
    'weekend_holiday': '주말/공휴일',
    'everyday': '매일'
  };
  return dayTypeMap[dayType] || dayType;
}

function highlightTime(time) {
  // Simple feedback for time selection
  const button = event.target;
  if (button) {
    button.classList.add('ring-2', 'ring-blue-300');
    setTimeout(() => {
      button.classList.remove('ring-2', 'ring-blue-300');
    }, 1000);
  }
}

function updateCurrentTime() {
  const now = new Date();
  const timeString = now.toLocaleTimeString('ko-KR', { 
    hour: '2-digit', 
    minute: '2-digit',
    hour12: false 
  });
  
  const timeElement = document.getElementById('current-time');
  if (timeElement) {
    timeElement.textContent = timeString;
  }
}

// Map functionality (existing code)
function initializeMap() {
  const mapContainer = document.getElementById('map');
  const stopsDataElement = document.getElementById('stopsData');
  
  if (!mapContainer || !stopsDataElement) {
    return;
  }
  
  // Kakao Maps API가 로드되었는지 확인
  if (typeof kakao === 'undefined' || typeof kakao.maps === 'undefined') {
    console.error('Kakao Maps API가 로드되지 않았습니다.');
    mapContainer.innerHTML = '<div class="flex items-center justify-center h-96 bg-gray-100 rounded-lg">' +
      '<div class="text-center">' +
        '<p class="text-gray-600 mb-2">지도를 불러올 수 없습니다.</p>' +
        '<p class="text-sm text-gray-500">잠시 후 다시 시도해주세요.</p>' +
      '</div>' +
    '</div>';
    return;
  }
  
  const stopsDataText = stopsDataElement.getAttribute('data-stops');
  if (!stopsDataText) {
    console.error('정류장 데이터가 없습니다.');
    return;
  }
  
  let stops = [];
  try {
    stops = JSON.parse(stopsDataText);
    if (!Array.isArray(stops)) {
      stops = [];
    }
  } catch (e) {
    console.error('Error parsing stops data JSON:', e);
    return;
  }
  
  let centerLat = 37.5665;
  let centerLng = 126.9780;
  
  if (stops.length > 0) {
    const validStops = stops.filter(stop => typeof stop.lat === 'number' && typeof stop.lng === 'number' && !isNaN(stop.lat) && !isNaN(stop.lng));
    if (validStops.length > 0) {
      const totalLat = validStops.reduce((sum, stop) => sum + stop.lat, 0);
      const totalLng = validStops.reduce((sum, stop) => sum + stop.lng, 0);
      centerLat = totalLat / validStops.length;
      centerLng = totalLng / validStops.length;
    }
  }
  
  try {
    const mapOption = {
      center: new kakao.maps.LatLng(centerLat, centerLng),
      level: 9 
    };
    
    const map = new kakao.maps.Map(mapContainer, mapOption);
    const markers = [];
    let currentInfoWindow = null;
    let roadview = null;
    let roadviewClient = null;
  
    function initRoadview() {
      if (!roadview) {
        const roadviewContainerEl = document.getElementById('roadview');
        if (roadviewContainerEl) {
          roadview = new kakao.maps.Roadview(roadviewContainerEl);
          roadviewClient = new kakao.maps.RoadviewClient();
        }
      }
    }
  
    function showRoadview(lat, lng, stopName) {
      initRoadview();
      if (!roadview || !roadviewClient) {
        alert('로드뷰를 불러올 수 없습니다. 다시 시도해주세요.');
        return;
      }
      const position = new kakao.maps.LatLng(lat, lng);
      roadviewClient.getNearestPanoId(position, 100, function(panoId) {
        const roadviewDisplayContainer = document.getElementById('roadviewContainer');
        if (panoId === null) {
          alert('이 위치에서는 로드뷰를 사용할 수 없습니다.');
          if (roadviewDisplayContainer) roadviewDisplayContainer.style.display = 'none';
        } else {
          if (roadviewDisplayContainer) {
            roadviewDisplayContainer.style.display = 'block';
            const roadviewTitleEl = roadviewDisplayContainer.querySelector('h3');
            if (roadviewTitleEl) {
              roadviewTitleEl.textContent = stopName + ' 로드뷰';
            }
            roadview.setPanoId(panoId, position);
            roadviewDisplayContainer.scrollIntoView({ behavior: 'smooth' });
          }
        }
      });
    }
  
    window.closeRoadview = function() {
      const roadviewContainer = document.getElementById('roadviewContainer');
      if (roadviewContainer) {
        roadviewContainer.style.display = 'none';
      }
    };
  
    if (stops.length > 0) {
      stops.forEach((stop, index) => {
        if (typeof stop.lat !== 'number' || typeof stop.lng !== 'number' || isNaN(stop.lat) || isNaN(stop.lng)) {
          return;
        }
        const markerPosition = new kakao.maps.LatLng(stop.lat, stop.lng);
        const marker = new kakao.maps.Marker({
          position: markerPosition,
          map: map
        });
        
        const stopNameForFunction = String(stop.name).replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const infoContent = 
          '<div style="padding:12px; min-width:200px; font-family: Arial, sans-serif; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); border-radius: 6px;">' +
            '<div style="font-weight: 600; font-size: 15px; margin-bottom: 8px; color: #333;">' + (index + 1) + '. ' + stop.name + '</div>' +
            '<div style="margin-bottom: 8px;">' +
              '<button onclick="window.openRoadviewForStop(' + index + ')" style="background: #007bff; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 13px; margin-right: 5px;">로드뷰</button>' +
              '<button onclick="window.showStopTimetableWrapper(\'' + stopNameForFunction + '\')" style="background: #28a745; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 13px;">시간표</button>' +
            '</div>' +
            '<button onclick="window.closeInfoWindow()" style="position: absolute; top: 8px; right: 8px; background: none; border: none; font-size: 18px; cursor: pointer; color: #888; line-height: 1;">&times;</button>' +
          '</div>';
        
        const infoWindow = new kakao.maps.InfoWindow({
          content: infoContent,
          disableAutoPan: true
        });
        
        kakao.maps.event.addListener(marker, 'click', function() {
          if (currentInfoWindow) {
            currentInfoWindow.close();
          }
          infoWindow.open(map, marker);
          currentInfoWindow = infoWindow;
        });
        markers.push({ marker: marker, infoWindow: infoWindow, stopData: stop });
      });
    }
  
    kakao.maps.event.addListener(map, 'click', function() {
      if (currentInfoWindow) {
        currentInfoWindow.close();
        currentInfoWindow = null;
      }
    });
  
    window.closeInfoWindow = function() {
      if (currentInfoWindow) {
        currentInfoWindow.close();
        currentInfoWindow = null;
      }
    };
  
    window.openRoadviewForStop = function(index) {
      if (markers[index] && markers[index].stopData) {
        const stop = markers[index].stopData;
        showRoadview(stop.lat, stop.lng, stop.name);
      }
    };
  
    window.moveToMarker = function(index) {
      if (index < 0 || index >= markers.length) return;
      const markerData = markers[index];
      if (!markerData || !markerData.stopData) return;
      const stop = markerData.stopData;
      const moveLatLng = new kakao.maps.LatLng(stop.lat, stop.lng);
      map.setCenter(moveLatLng);
      map.setLevel(4, {animate: true});
      if (currentInfoWindow) currentInfoWindow.close();
      markerData.infoWindow.open(map, markerData.marker);
      currentInfoWindow = markerData.infoWindow;
    };

    window.moveToMarkerAndScroll = function(index) {
      // 먼저 지도로 스크롤
      const mapContainer = document.getElementById('map');
      if (mapContainer) {
        mapContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      
      // 약간의 지연 후 마커 이동 (스크롤 애니메이션과 함께 부드럽게)
      setTimeout(() => {
        window.moveToMarker(index);
      }, 300);
    };
  
    if (markers.length > 0) {
      const bounds = new kakao.maps.LatLngBounds();
      markers.forEach(markerData => {
         if (markerData.stopData && typeof markerData.stopData.lat === 'number' && typeof markerData.stopData.lng === 'number') {
          bounds.extend(new kakao.maps.LatLng(markerData.stopData.lat, markerData.stopData.lng));
        }
      });
      if (!bounds.isEmpty()) {
          map.setBounds(bounds);
      }
    }
  } catch (e) {
    console.error('Error initializing map:', e);
  }
}

// Legacy compatibility functions
window.showStopTimetableWrapper = function(stopName) {
  // Select the stop in the new interface
  const stopSelector = document.getElementById('stop-selector');
  if (stopSelector) {
    stopSelector.value = stopName;
    selectStop(stopName);
  }
  
  // Scroll to timetable section
  const timetableSection = document.getElementById('timetable-section');
  if (timetableSection) {
    timetableSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
};

// Expose functions globally
window.switchDirection = switchDirection;
window.selectStop = selectStop;
window.highlightTime = highlightTime;
</script> 