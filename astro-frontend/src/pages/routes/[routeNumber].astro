---
import Layout from '../../layouts/Layout.astro';
import { client } from '../../lib/sanityClient.js';
import { toHTML } from '@portabletext/to-html';

// Get the route number from the URL parameter
const { routeNumber } = Astro.params;

// Fetch the specific bus route data from Sanity
const route = await client.fetch(`
  *[_type == "busRoute" && routeNumber == $routeNumber][0]{
    routeName,
    routeNumber, 
    description,
    mainStops,
    usageGuide,
    kakaoMapIframeUrl,
    timetableNotes,
    _id
  }
`, { routeNumber });

// If route doesn't exist, return 404
if (!route) {
  return Astro.redirect('/404');
}

// Fetch JSON data for detailed route information
let jsonData = null;
try {
  const response = await fetch(`${Astro.url.origin}/data/${routeNumber}.json`);
  if (response.ok) {
    jsonData = await response.json();
  }
} catch (error) {
  console.log('JSON data not found for route:', routeNumber);
}

// Fetch related timetable entries
const timetableEntries = await client.fetch(`
  *[_type == "timetableEntry" && route._ref == $routeId]{
    dayType,
    direction,
    departureTimes,
    stopName,
    effectiveDate,
    status
  } | order(direction asc, dayType asc, stopName asc)
`, { routeId: route._id });

// Helper function to render portable text
const renderPortableText = (content) => {
  if (!content) return '';
  return toHTML(content);
};

// Group timetable entries by direction and day type
const groupedTimetables = {};
timetableEntries.forEach(entry => {
  const key = `${entry.direction}-${entry.dayType}`;
  if (!groupedTimetables[key]) {
    groupedTimetables[key] = [];
  }
  groupedTimetables[key].push(entry);
});

// Helper function to get day type display name
const getDayTypeDisplay = (dayType) => {
  const dayTypeMap = {
    'weekday': 'í‰ì¼',
    'weekend_holiday': 'ì£¼ë§/ê³µíœ´ì¼',
    'everyday': 'ë§¤ì¼'
  };
  return dayTypeMap[dayType] || dayType;
};

// Extract main area from route name for SEO
const getMainArea = (routeName) => {
  if (routeName?.includes('ê°•ë‚¨')) return 'ê°•ë‚¨';
  if (routeName?.includes('ì ì‹¤')) return 'ì ì‹¤';
  if (routeName?.includes('ë™ëŒ€ë¬¸')) return 'ë™ëŒ€ë¬¸';
  if (routeName?.includes('í™ëŒ€')) return 'í™ëŒ€';
  if (routeName?.includes('ëª…ë™')) return 'ëª…ë™';
  return 'ì„œìš¸';
};

const mainArea = getMainArea(route.routeName);

// Generate static paths for all routes
export async function getStaticPaths() {
  const routes = await client.fetch(`
    *[_type == "busRoute"]{
      routeNumber
    }
  `);
  
  return routes.map((route) => ({
    params: { routeNumber: route.routeNumber },
  }));
}

// SEO-optimized title and description
const seoTitle = `${route.routeNumber} ê³µí•­ë²„ìŠ¤ ì‹œê°„í‘œ ì˜ˆë§¤ - ${mainArea}â†”ì¸ì²œê³µí•­ ìš”ê¸ˆ/ì†Œìš”ì‹œê°„`;
const seoDescription = `${route.routeNumber} ê³µí•­ë²„ìŠ¤ ì‹¤ì‹œê°„ ì‹œê°„í‘œì™€ ì˜¨ë¼ì¸ ì˜ˆë§¤ ì„œë¹„ìŠ¤. ${mainArea}ì—ì„œ ì¸ì²œê³µí•­ê¹Œì§€ì˜ ìš”ê¸ˆ, ì†Œìš”ì‹œê°„, ì •ë¥˜ì¥ ìœ„ì¹˜ ì •ë³´ë¥¼ í™•ì¸í•˜ê³  í¸ë¦¬í•˜ê²Œ ì˜ˆë§¤í•˜ì„¸ìš”.`;
---

<Layout title={seoTitle}>
  <!-- SEO Meta Tags -->
  <meta name="description" content={seoDescription} />
  <meta name="keywords" content={`${route.routeNumber} ê³µí•­ë²„ìŠ¤, ${route.routeNumber} ê³µí•­ë²„ìŠ¤ ì‹œê°„í‘œ, ${route.routeNumber} ê³µí•­ë²„ìŠ¤ ì˜ˆë§¤, ${route.routeNumber} ê³µí•­ë²„ìŠ¤ ìš”ê¸ˆ, ${mainArea} ê³µí•­ë²„ìŠ¤, ê³µí•­ë²„ìŠ¤ ì •ë¥˜ì¥, ê³µí•­ë²„ìŠ¤ ì†Œìš”ì‹œê°„`} />
  
  <!-- Kakao Map API -->
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9dee7ba39e07c39710261487dceadbcb&libraries=services,clusterer,drawing,roadview"></script>
  
  <!-- Structured Data for Transportation Service -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "TransportationService",
    "name": `${route.routeNumber} ê³µí•­ë²„ìŠ¤`,
    "description": `${mainArea}ì—ì„œ ì¸ì²œê³µí•­ì„ ì—°ê²°í•˜ëŠ” ${route.routeNumber}ë²ˆ ê³µí•­ë²„ìŠ¤ ì„œë¹„ìŠ¤`,
    "provider": {
      "@type": "Organization",
      "name": "ì¸ì²œê³µí•­ ë²„ìŠ¤ ì •ë³´"
    },
    "areaServed": {
      "@type": "Place",
      "name": `${mainArea}, ì„œìš¸íŠ¹ë³„ì‹œ`
    },
    "hasRoute": {
      "@type": "TransportationRoute",
      "name": `${route.routeNumber} ê³µí•­ë²„ìŠ¤ ë…¸ì„ `,
      "description": `${mainArea}ì—ì„œ ì¸ì²œê³µí•­ê¹Œì§€ì˜ ì§í–‰ ë…¸ì„ `
    }
  })}></script>

  <!-- Breadcrumb Schema -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "ê³µí•­ë²„ìŠ¤",
        "item": "/"
      },
      {
        "@type": "ListItem", 
        "position": 2,
        "name": "ì „ì²´ ë…¸ì„ ",
        "item": "/routes"
      },
      {
        "@type": "ListItem",
        "position": 3,
        "name": `${route.routeNumber} ê³µí•­ë²„ìŠ¤`
      }
    ]
  })}></script>

  <div class="max-w-6xl mx-auto">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb" class="mb-6">
      <div class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
        <a href="/" class="hover:text-blue-600 dark:hover:text-blue-400">ê³µí•­ë²„ìŠ¤ í™ˆ</a>
        <span>></span>
        <a href="/routes" class="hover:text-blue-600 dark:hover:text-blue-400">ì „ì²´ ë…¸ì„ </a>
        <span>></span>
        <span class="text-gray-800 dark:text-gray-200">{route.routeNumber} ê³µí•­ë²„ìŠ¤</span>
      </div>
    </nav>

    <!-- Back Button -->
    <div class="mb-6">
      <a 
        href="/routes" 
        class="inline-flex items-center space-x-2 text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium transition duration-200"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        <span>ì „ì²´ ê³µí•­ë²„ìŠ¤ ë…¸ì„ ìœ¼ë¡œ ëŒì•„ê°€ê¸°</span>
      </a>
    </div>

    <!-- SEO-Optimized Route Header -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-8 mb-8 border border-gray-200 dark:border-gray-700">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
        <div>
          <div class="flex items-center space-x-4 mb-4">
            <span class="text-4xl font-bold text-blue-600 dark:text-blue-400">
              {route.routeNumber}
            </span>
            <span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-sm font-semibold px-3 py-1 rounded">
              ê³µí•­ë²„ìŠ¤
            </span>
          </div>
          <!-- SEO H1 with target keywords -->
          <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">
            ê¸°ë³¸ ìš´í–‰ì •ë³´ - {mainArea} â†” ì¸ì²œê³µí•­
          </h1>
        </div>
      </div>
      
      {route.description && (
        <p class="text-lg text-gray-600 dark:text-gray-300 leading-relaxed mb-6">
          {route.description} ê³µí•­ë²„ìŠ¤ ì˜ˆë§¤ì™€ ìš”ê¸ˆ ì •ë³´, ì •ë¥˜ì¥ ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ê³  í¸ë¦¬í•˜ê²Œ ì´ìš©í•˜ì„¸ìš”.
        </p>
      )}

      <!-- Enhanced Route Information from JSON -->
      {jsonData && (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-6">
          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
            <h3 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">ìš”ê¸ˆ ì •ë³´</h3>
            <p class="text-2xl font-bold text-blue-600 dark:text-blue-400">{jsonData.fare?.toLocaleString()}ì›</p>
          </div>
          <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
            <h3 class="font-semibold text-green-800 dark:text-green-200 mb-2">ì†Œìš” ì‹œê°„ (í‰ê· )</h3>
            <p class="text-lg font-semibold text-green-600 dark:text-green-400">{jsonData.duration}</p>
          </div>
          <div class="bg-orange-50 dark:bg-orange-900/20 p-4 rounded-lg">
            <h3 class="font-semibold text-orange-800 dark:text-orange-200 mb-2">ìš´í–‰ ê°„ê²©</h3>
            <p class="text-lg font-semibold text-orange-600 dark:text-orange-400">{jsonData.interval}</p>
          </div>
          <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg">
            <h3 class="font-semibold text-purple-800 dark:text-purple-200 mb-2">ìš´ì˜ì‚¬</h3>
            <p class="text-medium font-medium text-purple-600 dark:text-purple-400">{jsonData.company}</p>
            {jsonData.companyTel && (
              <p class="text-s text-purple-500 dark:text-purple-400 mt-1">{jsonData.companyTel}</p>
            )}
          </div>
        </div>
      )}
    </div>

    <!-- Bus Stops with Kakao Map -->
    {jsonData?.geoInfo?.stops && jsonData.geoInfo.stops.length > 0 && (
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 border border-gray-200 dark:border-gray-700">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
          <svg class="w-6 h-6 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          {route.routeNumber} ê³µí•­ë²„ìŠ¤ ì •ë¥˜ì¥ ìœ„ì¹˜
        </h2>
        <p class="text-gray-600 dark:text-gray-300 mb-6">
          {route.routeNumber} ê³µí•­ë²„ìŠ¤ê°€ ì •ì°¨í•˜ëŠ” ì •ë¥˜ì¥ ìœ„ì¹˜ì…ë‹ˆë‹¤. ì§€ë„ì—ì„œ ê° ì •ë¥˜ì¥ì˜ ìì„¸í•œ ìœ„ì¹˜ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.
        </p>

        <!-- Kakao Map -->
        <div class="mb-6">
          <div id="map" class="w-full h-96 rounded-lg border border-gray-200 dark:border-gray-600"></div>
        </div>

        <!-- Roadview Container (initially hidden) -->
        <div id="roadviewContainer" class="mb-6" style="display: none;">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white">ë¡œë“œë·°</h3>
            <button 
              onclick="closeRoadview()" 
              class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 text-sm font-medium"
            >
              ë¡œë“œë·° ë‹«ê¸°
            </button>
          </div>
          <div id="roadview" class="w-full h-96 rounded-lg border border-gray-200 dark:border-gray-600"></div>
        </div>

        <!-- Stop List with Coordinates -->
        <div class="grid grid-cols-2 gap-4">
          {jsonData.geoInfo.stops.map((stop, index) => (
            <div class="flex flex-col p-3 bg-gray-50 dark:bg-gray-700 rounded-lg space-y-2 items-start">
              <div class="flex items-center space-x-3 w-full">
                <span class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white text-sm font-bold rounded-full flex items-center justify-center">
                  {index + 1}
                </span>
                <div>
                  <span class="text-gray-800 dark:text-gray-200 font-medium block text-sm">{stop.name}</span>
                </div>
              </div>
              <div class="flex space-x-2 w-full justify-start pt-1 pl-11">
                <button 
                  onclick={`moveToMarker(${index})`}
                  class="text-xs px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded-md transition-colors duration-150 flex items-center"
                >
                  <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0zM15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                  ì§€ë„
                </button>
                <button 
                  onclick={`showStopTimetable('${stop.name}')`}
                  class="text-xs px-2 py-1 bg-green-500 hover:bg-green-600 text-white rounded-md transition-colors duration-150 flex items-center"
                >
                  <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                  ì‹œê°„í‘œ
                </button>
              </div>
            </div>
          ))}
        </div>

        <!-- Store stops data in a data attribute -->
        <div id="stopsData" data-stops={JSON.stringify(jsonData.geoInfo.stops)} style="display: none;"></div>
      </div>
    )}

    <!-- Main Stops Section (fallback if no JSON data) -->
    {(!jsonData?.geoInfo?.stops || jsonData.geoInfo.stops.length === 0) && route.mainStops && route.mainStops.length > 0 && (
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 border border-gray-200 dark:border-gray-700">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
          <svg class="w-6 h-6 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          ì •ë¥˜ì¥ ìœ„ì¹˜ ì•ˆë‚´
        </h2>
        <p class="text-gray-600 dark:text-gray-300 mb-4">
          {route.routeNumber} ê³µí•­ë²„ìŠ¤ê°€ ì •ì°¨í•˜ëŠ” ì£¼ìš” ì •ë¥˜ì¥ ìœ„ì¹˜ì…ë‹ˆë‹¤. ê° ì •ë¥˜ì¥ì—ì„œì˜ íƒ‘ìŠ¹ ì‹œê°„ì„ í™•ì¸í•˜ì—¬ ì—¬í–‰ ê³„íšì„ ì„¸ìš°ì„¸ìš”.
        </p>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          {route.mainStops.map((stop, index) => (
            <div class="flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
              <span class="flex-shrink-0 w-6 h-6 bg-blue-600 text-white text-xs font-bold rounded-full flex items-center justify-center">
                {index + 1}
              </span>
              <span class="text-gray-800 dark:text-gray-200 font-medium">{stop}</span>
            </div>
          ))}
        </div>
      </div>
    )}

    <!-- Timetable Section with SEO H2 -->
    {Object.keys(groupedTimetables).length > 0 && (
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 border border-gray-200 dark:border-gray-700">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
          <svg class="w-6 h-6 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          {route.routeNumber} ê³µí•­ë²„ìŠ¤ ì‹œê°„í‘œ
        </h2>
        <p class="text-gray-600 dark:text-gray-300 mb-6">
          {route.routeNumber} ê³µí•­ë²„ìŠ¤ì˜ ìš´í–‰ ì‹œê°„í‘œì…ë‹ˆë‹¤. 'ë§¤ì¼'ì´ë¼ í‘œì‹œëœ ì‹œê°„í‘œëŠ” í‰ì¼ê³¼ ì£¼ë§/ê³µíœ´ì¼ ì‹œê°„í‘œê°€ ë™ì¼í•©ë‹ˆë‹¤.
        </p>

        <div class="space-y-8" id="timetable-section">
          {Object.entries(groupedTimetables).map(([key, entries]) => {
            const [currentDirection, currentDayType] = key.split('-');
            // Group entries by stopName within this direction-dayType group
            const entriesByStop = entries.reduce((acc, entry) => {
              const stopKey = entry.stopName || 'unknown';
              if (!acc[stopKey]) {
                acc[stopKey] = {
                  stopName: entry.stopName,
                  dayTypes: {}
                };
              }
              if (!acc[stopKey].dayTypes[currentDayType]) {
                acc[stopKey].dayTypes[currentDayType] = [];
              }
              acc[stopKey].dayTypes[currentDayType].push(entry);
              return acc;
            }, {});

            // Determine if this entire block is for 'ì‹œë‚´í–‰'
            const isCityBoundBlock = currentDirection === 'ì‹œë‚´í–‰';

            return Object.values(entriesByStop).map(stopGroup => {
              return Object.entries(stopGroup.dayTypes).map(([dayType, dayTypeEntries]) => {
                const firstEntryForStopDayType = dayTypeEntries[0]; // All entries here share stopName, direction, dayType

                return (
                  <div 
                    class={`timetable-entry-item border border-gray-200 dark:border-gray-600 rounded-lg overflow-hidden mb-6 ${isCityBoundBlock ? 'city-bound-timetable' : 'specific-stop-timetable'}`}
                    data-stop-name={firstEntryForStopDayType.stopName}
                    data-direction={firstEntryForStopDayType.direction} 
                    data-day-type={dayType}
                    style={isCityBoundBlock ? '' : 'display: none;'}
                    id={`timetable-${routeNumber}-${firstEntryForStopDayType.direction}-${dayType}-${firstEntryForStopDayType.stopName?.replace(/\s+/g, '-')}`}
                  >
                    <div class={`
                      px-4 py-3 border-b border-gray-200 dark:border-gray-600 
                      ${firstEntryForStopDayType.direction === 'ê³µí•­í–‰' 
                        ? 'bg-blue-200 dark:bg-blue-700' 
                        : 'bg-green-200 dark:bg-green-700'}
                    `}>
                      <h3 class={`
                        text-lg font-semibold 
                        ${firstEntryForStopDayType.direction === 'ê³µí•­í–‰' 
                          ? 'text-blue-800 dark:text-blue-100' 
                          : 'text-green-800 dark:text-green-100'}
                      `}>
                        {firstEntryForStopDayType.direction} - {getDayTypeDisplay(dayType)} ({firstEntryForStopDayType.stopName || 'ì •ë¥˜ì¥ëª… ë¯¸ë“±ë¡'})
                      </h3>
                    </div>
                    <div class="p-4">
                      {dayTypeEntries.map((entry, index) => (
                        <div class="mb-6 last:mb-0" key={`${entry.stopName}-${index}`}> {/* Key should be more unique if stopName can be null */}
                          {/* We already have stopName in the header for this block */}
                          {entry.departureTimes && entry.departureTimes.length > 0 ? (
                            <div class="grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 lg:grid-cols-12 gap-2">
                              {entry.departureTimes.map((time, timeIndex) => (
                                <span 
                                  key={timeIndex}
                                  class="text-center py-2 px-1 bg-blue-50 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded text-sm font-mono"
                                >
                                  {time}
                                </span>
                              ))}
                            </div>
                          ) : (
                            <p class="text-gray-500 dark:text-gray-400">í•´ë‹¹ ë‚ ì§œì˜ ì‹œê°„í‘œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                );
              });
            });
          })}
        </div>

        {route.timetableNotes && (
          <div class="mt-6 p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
            <h4 class="font-medium text-yellow-800 dark:text-yellow-200 mb-2">ê³µí•­ë²„ìŠ¤ ì‹œê°„í‘œ ì°¸ê³ ì‚¬í•­</h4>
            <div class="text-yellow-700 dark:text-yellow-300 prose prose-sm max-w-none" set:html={renderPortableText(route.timetableNotes)}></div>
          </div>
        )}
      </div>
    )}

    <!-- Usage Guide Section - Enhanced with JSON data -->
    {(route.usageGuide || jsonData?.usageGuide) && (
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 border border-gray-200 dark:border-gray-700">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
          <svg class="w-6 h-6 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          ì´ìš© ì•ˆë‚´ ë° ì˜ˆë§¤ ì •ë³´
        </h2>
        
        <!-- JSON Usage Guide (priority) -->
        {jsonData?.usageGuide && (
          <ul class="space-y-3 list-none mb-6">
            {jsonData.usageGuide.map((guide, index) => {
              let displayText = guide.text;
              if (guide.links && guide.links.length > 0) {
                guide.links.forEach(link => {
                  if (guide.text.includes(link.text)) {
                    displayText = displayText.replace(
                      link.text,
                      `<a href="${link.url}" target="${link.target || '_self'}" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 underline font-medium">${link.text}</a>`
                    );
                  }
                });
              }
              return (
                <li class="flex items-start p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600">
                  <svg class="w-5 h-5 mr-3 mt-1 text-blue-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                  <span class="text-gray-700 dark:text-gray-300" set:html={displayText}></span>
                </li>
              );
            })}
          </ul>
        )}
        
        <!-- Sanity Usage Guide (fallback) -->
        {route.usageGuide && !jsonData?.usageGuide && (
          <div class="prose prose-lg max-w-none dark:prose-invert" set:html={renderPortableText(route.usageGuide)}></div>
        )}
      </div>
    )}

    <!-- Kakao Map Section (iframe fallback) -->
    {route.kakaoMapIframeUrl && (
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 border border-gray-200 dark:border-gray-700">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
          <svg class="w-6 h-6 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m-6 3l6-3"></path>
          </svg>
          ì‹¤ì‹œê°„ ë²„ìŠ¤ ìœ„ì¹˜
        </h2>
        <p class="text-gray-600 dark:text-gray-300 mb-4">
          {route.routeNumber} ê³µí•­ë²„ìŠ¤ì˜ ì‹¤ì‹œê°„ ìš´í–‰ ìœ„ì¹˜ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì •ë¥˜ì¥ ë„ì°© ì˜ˆì • ì‹œê°„ì„ ë¯¸ë¦¬ í™•ì¸í•˜ì—¬ ëŒ€ê¸° ì‹œê°„ì„ ë‹¨ì¶•í•˜ì„¸ìš”.
        </p>
        <div class="w-full h-96 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-600">
          <iframe 
            src={route.kakaoMapIframeUrl}
            width="100%" 
            height="100%" 
            frameborder="0" 
            style="border:0;" 
            allowfullscreen=""
            loading="lazy"
            title={`${route.routeNumber} ê³µí•­ë²„ìŠ¤ ì‹¤ì‹œê°„ ìœ„ì¹˜`}
          ></iframe>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-3">
          * {route.routeNumber} ê³µí•­ë²„ìŠ¤ ì‹¤ì‹œê°„ ìœ„ì¹˜ ì •ë³´ëŠ” ì¹´ì¹´ì˜¤ë§µì—ì„œ ì œê³µë©ë‹ˆë‹¤.
        </p>
      </div>
    )}

    <!-- Airport Usage Guide Section -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 border border-gray-200 dark:border-gray-700">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">
        ê³µí•­ ì´ìš© ê°€ì´ë“œ
      </h2>
      <div class="space-y-4">
        <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border-l-4 border-blue-500">
          <h3 class="text-lg font-semibold text-blue-800 dark:text-blue-200 mb-2">
            ì¸ì²œê³µí•­ ê³µí•­ë²„ìŠ¤ ìŠ¹í•˜ì°¨ì¥ ì•ˆë‚´
          </h3>
          <p class="text-blue-700 dark:text-blue-300 mb-3">
            ì¸ì²œê³µí•­ ì œ1í„°ë¯¸ë„ê³¼ ì œ2í„°ë¯¸ë„ì˜ ê³µí•­ë²„ìŠ¤ ìŠ¹í•˜ì°¨ì¥ ìœ„ì¹˜ì™€ ì´ìš© ë°©ë²•ì„ ìì„¸íˆ ì•ˆë‚´í•©ë‹ˆë‹¤.
          </p>
          <a 
            href="https://koreabusinfo.com/icn-bus-info/bus-stops/" 
            target="_blank"
            class="inline-flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200"
          >
            <span>ìŠ¹í•˜ì°¨ì¥ ì•ˆë‚´ ë³´ê¸°</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
            </svg>
          </a>
        </div>
        <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border-l-4 border-green-500">
          <h3 class="text-lg font-semibold text-green-800 dark:text-green-200 mb-2">
            ì¸ì²œê³µí•­ ê³µí•­ë²„ìŠ¤ ë¬´ì¸ë°œê¶Œê¸° ì´ìš© ë°©ë²•
          </h3>
          <p class="text-green-700 dark:text-green-300 mb-3">
            ì¸ì²œê³µí•­ ë¬´ì¸ë°œê¶Œê¸°ë¥¼ ì´ìš©í•œ ê³µí•­ë²„ìŠ¤ í‹°ì¼“ êµ¬ë§¤ ë°©ë²•ê³¼ ì˜ˆë§¤ ë‚´ì—­ í™•ì¸ ë°©ë²•ì„ ë‹¨ê³„ë³„ë¡œ ì•ˆë‚´í•©ë‹ˆë‹¤.
          </p>
          <a 
            href="https://koreabusinfo.com/icn-bus-info/unmanned-ticket-machine-guide/" 
            target="_blank"
            class="inline-flex items-center space-x-2 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200"
          >
            <span>ë¬´ì¸ë°œê¶Œê¸° ì´ìš©ë²• ë³´ê¸°</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
            </svg>
          </a>
        </div>
      </div>
    </div>

    <!-- Back to Routes Button -->
    <div class="text-center">
      <a 
        href="/routes" 
        class="inline-flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition duration-200"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        <span>ì „ì²´ ê³µí•­ë²„ìŠ¤ ë…¸ì„  ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</span>
      </a>
    </div>
  </div>
</Layout>

<script is:inline set:html={`
  window.timetableData = ${JSON.stringify(timetableEntries)};
`}/>

<script is:inline>
document.addEventListener('DOMContentLoaded', function() {
  // Check if map container and stops data exist
  const mapContainer = document.getElementById('map');
  const stopsDataElement = document.getElementById('stopsData');
  
  if (!mapContainer || !stopsDataElement) {
    return;
  }
  
  // Get stops data
  const stopsData = stopsDataElement.getAttribute('data-stops');
  if (!stopsData) {
    return;
  }
  
  const stops = JSON.parse(stopsData);
  
  // Calculate center point from all stops
  let centerLat = 37.5665; // Default latitude
  let centerLng = 126.9780; // Default longitude
  
  if (stops.length > 0) {
    const totalLat = stops.reduce((sum, stop) => sum + stop.lat, 0);
    const totalLng = stops.reduce((sum, stop) => sum + stop.lng, 0);
    centerLat = totalLat / stops.length;
    centerLng = totalLng / stops.length;
  }
  
  // Initialize Kakao Map
  const mapOption = {
    center: new kakao.maps.LatLng(centerLat, centerLng),
    level: 8
  };
  
  const map = new kakao.maps.Map(mapContainer, mapOption);
  const markers = [];
  let currentInfoWindow = null; // í˜„ì¬ ì—´ë¦° ì¸í¬ìœˆë„ìš° ì¶”ì 
  let roadview = null; // ë¡œë“œë·° ê°ì²´
  let roadviewClient = null; // ë¡œë“œë·° í´ë¼ì´ì–¸íŠ¸
  
  // Initialize Roadview
  function initRoadview() {
    if (!roadview) {
      const roadviewContainer = document.getElementById('roadview');
      if (roadviewContainer) {
        roadview = new kakao.maps.Roadview(roadviewContainer);
        roadviewClient = new kakao.maps.RoadviewClient();
      }
    }
  }
  
  // Show roadview for specific coordinates
  function showRoadview(lat, lng, stopName) {
    initRoadview();
    
    if (!roadview || !roadviewClient) {
      alert('ë¡œë“œë·°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    const position = new kakao.maps.LatLng(lat, lng);
    
    // Check if roadview is available at this location
    roadviewClient.getNearestPanoId(position, 100, function(panoId) {
      if (panoId === null) {
        alert('ì´ ìœ„ì¹˜ì—ì„œëŠ” ë¡œë“œë·°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      } else {
        // Show roadview container
        const roadviewContainer = document.getElementById('roadviewContainer');
        if (roadviewContainer) {
          roadviewContainer.style.display = 'block';
        }
        
        // Display roadview
        roadview.setPanoId(panoId, position);
        
        // Update roadview title
        const roadviewTitle = roadviewContainer.querySelector('h3');
        if (roadviewTitle) {
          roadviewTitle.textContent = stopName + ' ë¡œë“œë·°';
        }
        
        // Scroll to roadview
        roadviewContainer.scrollIntoView({ behavior: 'smooth' });
      }
    });
  }
  
  // Close roadview
  window.closeRoadview = function() {
    const roadviewContainer = document.getElementById('roadviewContainer');
    if (roadviewContainer) {
      roadviewContainer.style.display = 'none';
    }
  };
  
  // Create markers for each stop
  stops.forEach((stop, index) => {
    const markerPosition = new kakao.maps.LatLng(stop.lat, stop.lng);
    
    const marker = new kakao.maps.Marker({
      position: markerPosition,
      map: map
    });
    
    // Info window content with close button
    const infoContent = 
      '<div style="padding: 20px; min-width: 220px; max-width: 300px; position: relative; font-family: inherit;">' +
        '<div style="font-weight: 600; font-size: 16px; margin-bottom: 12px; padding-right: 25px; color: #1f2937; line-height: 1.3;">' + (index + 1) + '. ' + stop.name + '</div>' +
        '<div style="margin-bottom: 8px;">' +
          '<button onclick="openRoadviewForStop(' + index + ')" style="background: #007bff; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,123,255,0.3);" onmouseover="this.style.background=\'#0056b3\'" onmouseout="this.style.background=\'#007bff\'">ğŸ›£ï¸ ë¡œë“œë·° ë³´ê¸°</button>' +
        '</div>' +
        '<button onclick="closeInfoWindow()" style="position: absolute; top: 10px; right: 10px; background: #f3f4f6; border: none; font-size: 16px; cursor: pointer; color: #6b7280; line-height: 1; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background=\'#e5e7eb\'" onmouseout="this.style.background=\'#f3f4f6\'">Ã—</button>' +
      '</div>';
    
    const infoWindow = new kakao.maps.InfoWindow({
      content: infoContent
    });
    
    // Show info window on marker click
    kakao.maps.event.addListener(marker, 'click', function() {
      // Close previous info window
      if (currentInfoWindow) {
        currentInfoWindow.close();
      }
      
      // Open new info window
      infoWindow.open(map, marker);
      currentInfoWindow = infoWindow;
    });
    
    markers.push({ marker: marker, infoWindow: infoWindow });
  });
  
  // Close info window when clicking on map
  kakao.maps.event.addListener(map, 'click', function() {
    if (currentInfoWindow) {
      currentInfoWindow.close();
      currentInfoWindow = null;
    }
  });
  
  // Global function to close info window
  window.closeInfoWindow = function() {
    if (currentInfoWindow) {
      currentInfoWindow.close();
      currentInfoWindow = null;
    }
  };
  
  // Global function to open roadview for specific stop
  window.openRoadviewForStop = function(index) {
    if (index >= 0 && index < stops.length) {
      const stop = stops[index];
      showRoadview(stop.lat, stop.lng, stop.name);
    }
  };
  
  // Function to move to specific marker
  window.moveToMarker = function(index) {
    if (index < 0 || index >= stops.length) {
      return;
    }
    
    const stop = stops[index];
    const moveLatLng = new kakao.maps.LatLng(stop.lat, stop.lng);
    
    map.setCenter(moveLatLng);
    map.setLevel(3);
    
    // Close previous info window
    if (currentInfoWindow) {
      currentInfoWindow.close();
    }
    
    // Open info window for the selected marker
    markers[index].infoWindow.open(map, markers[index].marker);
    currentInfoWindow = markers[index].infoWindow;
  };
  
  // Adjust map bounds to show all markers
  if (stops.length > 0) {
    const bounds = new kakao.maps.LatLngBounds();
    stops.forEach(stop => {
      bounds.extend(new kakao.maps.LatLng(stop.lat, stop.lng));
    });
    map.setBounds(bounds);
    
    // Set specific zoom level after setBounds
    setTimeout(function() {
      map.setLevel(8);
    }, 100);
  }
});

window.showStopTimetable = function(clickedStopName) {
  if (!window.timetableData) {
    console.error('Timetable data not loaded.');
    return;
  }

  // Find the direction for the clicked stopName
  let clickedStopDirection = null;
  const entryForClickedStop = window.timetableData.find(entry => entry.stopName === clickedStopName);

  if (entryForClickedStop) {
    clickedStopDirection = entryForClickedStop.direction;
  } else {
    console.warn(`No timetable entry found for stop: ${clickedStopName}. Cannot determine direction.`);
  }

  // Hide all currently shown specific (non-city-bound) stop timetables
  const allTimetableItems = document.querySelectorAll('.timetable-entry-item');
  allTimetableItems.forEach(item => {
    if (item.classList.contains('specific-stop-timetable')) {
      item.style.display = 'none';
    }
  });

  // If we found a direction, show all timetables for the clicked stop and its determined direction
  if (clickedStopDirection) {
    const timetablesToShow = document.querySelectorAll(
      `.timetable-entry-item[data-stop-name="${clickedStopName}"][data-direction="${clickedStopDirection}"]`
    );
    timetablesToShow.forEach(item => {
      item.style.display = 'block';
    });
  } else {
    console.log(`No specific direction found for ${clickedStopName}, only showing default city-bound timetables.`);
  }

  // Scrolling is now handled by scrollToTimetableSectionOnly or not at all for other stops.
  // const timetableSection = document.getElementById('timetable-section');
  // if (timetableSection) {
  //   timetableSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  // }
};
</script> 